!function(t){"use strict";function e(){var e="/favicon-32x32.png?v=3",a="/img/favicon-today.png?v=2",s=f.find(".task--today").length;t("link[rel$=icon]").remove(),s>0?(t("head").append(t('<link rel="icon" type="image/png" sizes="32x32">').attr("href",a)),Tinycon.setBubble(s)):t("head").append(t('<link rel="icon" type="image/png" sizes="32x32">').attr("href",e))}function a(){for(var t="",e="0123456789abcdefghijklmnopqrstuvwxyz",a=0;a<8;a++)t+=e.charAt(Math.floor(Math.random()*e.length));return t}function s(t){var e=f.find('.list[data-id="'+t+'"] .task:not(.task--add)').length,a=f.find('.list[data-id="'+t+'"] .task--completed').length;if(e>0)var s=100*a/e/100;else var s=0;f.find('.list[data-id="'+t+'"] .list__progress').css({"-webkit-transform":"scaleX("+s+")",transform:"scaleX("+s+")"})}function i(t,e){return'<div class="list" data-id="'+t+'"><div class="list__head"><div class="list__wrap"><div class="list__name  js-name">'+e+'</div><div class="list__options"><div class="list__trash  js-remove-list"><svg><use xlink:href="#icon-trash"></use></svg></div></div><div class="list__progress"></div></div><div class="list__grid  grid"></div></div><div class="list__tasks"><label class="task  task--add"><div class="task__wrap"><div class="task__status"><div class="task__plus"><svg><use xlink:href="#icon-plus"></use></svg></div></div><div class="task__name"><input class="task__input  js-add-task" type="text" maxlength="255"></div></div><div class="task__grid  grid"></div></label></div></div>'}function n(t){t.find(".grid__date.grid__date--past.grid__date--bull:not(.grid__date--completed)").length&&!t.find(".grid__date.grid__date--today.grid__date--completed").length&&t.find(".grid__date.grid__date--past.grid__date--bull:not(.grid__date--completed):last").index()>t.find(".grid__date.grid__date--past.grid__date--completed:last").index()?t.addClass("task--past"):t.removeClass("task--past"),t.find(".grid__date:not(.grid__date--past):not(.grid__date--completed).grid__date--bull").length?t.addClass("task--bull"):t.removeClass("task--bull"),t.find(".grid__date--today.grid__date--bull:not(.grid__date--completed)").length?t.addClass("task--today"):t.removeClass("task--today")}function r(t){var e=t;return e=/https:\/\/mahoweek\.ru\/#/.test(t)?e.replace(/(https:\/\/)(mahoweek\.ru\/#)([\S]+[^ ,\.!])/gi,'<a href="#$3" class="cartonbox" data-cb-type="inline" data-cb-hash="$3"><span class="hidden">$1</span>$2$3</a>'):e.replace(/(http(s)?:\/\/(www\.)?)([\S]+[^ ,\.!])/gi,'<a href="$1$4" class="js-link-task" target="_blank" rel="noopener noreferrer"><span class="hidden">$1</span>$4</a>'),e=e.replace(/(.+)?(\s)?(\[)((2[0-3]|[0-1]\d):([0-5]\d))(\])(\s)?(.+)?/gi,'<span class="hidden">$3</span><span class="task__time">$4</span><span class="hidden">$7</span> $1$9').trim(),/[!]{3,}/.test(t)&&(e="<strong>"+e.replace(/([!]{3,})/gi,'<span class="hidden">$1</span>')+"</strong>"),e}function d(t,e,a,s){if(1==a)var a=" task--completed";else var a="";return'<div class="task'+a+'" data-id="'+t+'"><div class="task__wrap"><div class="task__status"><div class="task__check  js-completed-task"></div></div><div class="task__name  js-name">'+r(e)+'</div><div class="task__options"><div class="task__trash  js-remove-task"><svg><use xlink:href="#icon-trash"></use></svg></div></div></div><div class="task__grid  grid">'+l("task",s)+"</div></div>"}function l(t,e){var a=new Date,s=a.getDay();0==s&&(s=7);var i=1;if(e)for(var n={},r=0;r<e.length;r++){var d=e[r].date;n[d]=e[r].label+"|"+(e[r].completed?1:0)}for(var l="",r=1-s;r<=14-s;r++){var o="",c=new Date,g=c.setDate(a.getDate()+r),f=c.getDate(g),m=c.getMonth(g)+1,u=c.getFullYear(g),k=c.getDay(),h=(f<10?"0"+f:f)+"."+(m<10?"0"+m:m)+"."+u;0==k&&(k=7),a.getDate()==f&&(o+=" grid__date--today",i=0),i&&(o+=" grid__date--past"),6!=k&&7!=k||(o+=" grid__date--holiday"),"task"==t&&(o+=" js-marker-task",n&&h in n&&("bull"==n[h].split("|")[0]&&(o+=" grid__date--bull"),1==n[h].split("|")[1]&&(o+=" grid__date--completed"))),l+='<div class="grid__date'+o+'" data-date="'+h+'">',"list"==t&&(l+=f),l+="</div>"}return l}if(function(){var t=1e3,e=new Date;setTimeout(function a(){var s=new Date;e.getDay()!=s.getDay()&&(location.reload(),e=s),setTimeout(a,t)},t)}(),setTimeout(function(){t("body").scrollTop(0)},1),/Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent)){t("body").addClass("mobile");var o=1}var c=t(".board"),g=c.find(".board__theme"),f=c.find(".board__lists"),m=t(".form--settings"),u=t(".form--storage");!function(){if(localStorage.getItem("mahoweek")){var e=JSON.parse(localStorage.getItem("mahoweek"));g.addClass("board__theme--"+e.settings.theme)}else{var s=a(),i="leaves",n={lists:[{id:s,name:"Краткосрочный план дел",createdTime:(new Date).getTime()}],tasks:[{id:a(),listId:s,name:"Прочитать справку о сайте: https://mahoweek.ru/#about",createdTime:(new Date).getTime()},{id:a(),listId:s,name:"Посмотреть как здесь всё устроено: https://mahoweek.ru/#tour",createdTime:(new Date).getTime()},{id:a(),listId:s,name:"Настроить доску: https://mahoweek.ru/#settings",createdTime:(new Date).getTime()},{id:a(),listId:s,name:"Добавить ещё дел в список",createdTime:(new Date).getTime()},{id:a(),listId:s,name:"Наметить на календарной сетке даты выполнения задач",createdTime:(new Date).getTime()}],settings:{theme:i}};localStorage.setItem("mahoweek",JSON.stringify(n)),g.addClass("board__theme--"+i),t("body").attr("data-visit","first")}}(),function(){var e=0,a=0,s=o?"touchstart":"mousedown";f.on(s,".js-name",function(t){if("touchstart"==t.type){var a=t.originalEvent.touches[0]||t.originalEvent.changedTouches[0];e=a.pageX+a.pageY}else e=t.pageX+t.pageY;f.find(".js-add-task").blur()});var i=o?"touchend":"mouseup";f.on(i,".js-name",function(s){var i=t(this);if("touchend"==s.type){var n=s.originalEvent.touches[0]||s.originalEvent.changedTouches[0];a=n.pageX+n.pageY}else a=s.pageX+s.pageY;if("mouseup"==s.type&&1!=s.which)return!1;if(!t(s.target).hasClass("js-link-task")&&!t(s.target).hasClass("cartonbox")&&e==a){if(i.hasClass("list__name")&&!i.parents(".list").find(".list__input").length){var d=i.text();i.html('<input class="list__input  js-edit-list" type="text" maxlength="255" value="">'),i.parents(".list").find(".list__input").val(d).select(),i.parents(".list").find(".list__input").focusout(function(){i.text(t(this).val())})}if(i.hasClass("task__name")&&!i.parents(".task").find(".task__input").length){var l=i.text();i.html('<input class="task__input  js-edit-task" type="text" maxlength="255" value="">'),i.parents(".task").find(".task__input").val(l).focus(),i.parents(".task").find(".task__input").focusout(function(){i.html(r(t(this).val()))})}}})}(),function(){var e={speed:1,preload:!1,closeHtml:'<svg><use xlink:href="#icon-close"></use></svg>',onStartBefore:function(){t(".cartonbox-close").prependTo(".cartonbox-container")},onShowBefore:function(){if("#storage"==window.location.hash){var t=JSON.parse(localStorage.getItem("mahoweek")),t=JSON.stringify(t,"",2);u.find(".js-edit-storage").val(t)}}};t.cartonbox(e),"first"==t("body").attr("data-visit")&&t(".js-open-welcome").trigger("click"),t(".js-close-welcome").on("click",function(){t(".cartonbox-close").trigger("click"),c.addClass("board--load")})}(),function(){var t={},e=null,a=null,s=null,i=null,n={},r=Math.ceil(window.devicePixelRatio)||1,d=16*r,l={width:16,height:16,font:11*r+"px Courier New",color:"#000",background:"transparent",fallback:!0,crossOrigin:!0,abbreviate:!0},o=function(){var t=navigator.userAgent.toLowerCase();return function(e){return t.indexOf(e)!==-1}}(),c={ie:o("trident"),chrome:o("chrome"),webkit:o("chrome")||o("safari"),safari:o("safari")&&!o("chrome"),mozilla:o("mozilla")&&!o("chrome")&&!o("safari")},g=function(){for(var t=document.getElementsByTagName("link"),e=0,a=t.length;e<a;e++)if((t[e].getAttribute("rel")||"").match(/\bicon\b/i))return t[e];return!1},f=function(){for(var t=document.getElementsByTagName("link"),e=0,a=t.length;e<a;e++){var s="undefined"!=typeof t[e];s&&(t[e].getAttribute("rel")||"").match(/\bicon\b/i)&&t[e].parentNode.removeChild(t[e])}},m=function(){if(!a||!e){var t=g();e=t?t.getAttribute("href"):"/favicon.ico",a||(a=e)}return e},u=function(){return i||(i=document.createElement("canvas"),i.width=d,i.height=d),i},k=function(t){if(t){f();var e=document.createElement("link");e.type="image/x-icon",e.rel="icon",e.href=t,document.getElementsByTagName("head")[0].appendChild(e)}},h=function(t,e){if(!u().getContext||c.ie||c.safari||"force"===n.fallback)return p(t);var a=u().getContext("2d"),e=e||"#000000",i=m();s=document.createElement("img"),s.onload=function(){a.clearRect(0,0,d,d),a.drawImage(s,2,2,s.width,s.height,0,0,d,d),(t+"").length>0&&_(a,t,e),v()},!i.match(/^data/)&&n.crossOrigin&&(s.crossOrigin="anonymous"),s.src=i},p=function(t){if(n.fallback){var e=document.title;"("===e[0]&&(e=e.slice(e.indexOf(" "))),(t+"").length>0?document.title="("+t+") "+e:document.title=e}},_=function(t,e,a){"number"==typeof e&&e>99&&n.abbreviate&&(e=b(e));var s=(e+"").length-1,i=n.width*r+6*r*s,l=n.height*r,o=d-l,g=d-i-r,f=16*r,m=16*r,u=2*r;t.font=(c.webkit?"bold ":"")+n.font,t.fillStyle=n.background,t.strokeStyle=n.background,t.lineWidth=r,t.beginPath(),t.moveTo(g+u,o),t.quadraticCurveTo(g,o,g,o+u),t.lineTo(g,f-u),t.quadraticCurveTo(g,f,g+u,f),t.lineTo(m-u,f),t.quadraticCurveTo(m,f,m,f-u),t.lineTo(m,o+u),t.quadraticCurveTo(m,o,m-u,o),t.closePath(),t.fill(),t.strokeStyle="rgba(255, 255, 255, 0.9)",t.lineWidth=2,t.textAlign="right",t.textBaseline="top",t.strokeText(e,2===r?32:16,c.mozilla?7*r:6*r),t.fillStyle=n.color,t.textAlign="right",t.textBaseline="top",t.fillText(e,2===r?32:16,c.mozilla?7*r:6*r)},v=function(){u().getContext&&k(u().toDataURL())},b=function(t){for(var e=[["G",1e9],["M",1e6],["k",1e3]],a=0;a<e.length;++a)if(t>=e[a][1]){t=w(t/e[a][1])+e[a][0];break}return t},w=function(t,e){var a=new Number(t);return a.toFixed(e)};t.setOptions=function(t){n={},t.colour&&(t.color=t.colour);for(var e in l)n[e]=t.hasOwnProperty(e)?t[e]:l[e];return this},t.setImage=function(t){return e=t,v(),this},t.setBubble=function(t,e){return t=t||"",h(t,e),this},t.reset=function(){e=a,k(a)},t.setOptions(l),"function"==typeof define&&define.amd?define(t):"undefined"!=typeof module?module.exports=t:window.Tinycon=t}(),function(){for(var t=JSON.parse(localStorage.getItem("mahoweek")),e="",a=0;a<t.lists.length;a++)e+=i(t.lists[a].id,t.lists[a].name);f.prepend(e)}(),f.find(".list__grid").html(l("list")),f.find(".task__grid").html(l()),function(){t(".js-add-list").on("click",function(){var e=a(),s="Краткосрочный план дел №"+(f.find(".list").length+1),n=(new Date).getTime(),r=JSON.parse(localStorage.getItem("mahoweek"));r.lists.push({id:e,name:s,createdTime:n}),localStorage.setItem("mahoweek",JSON.stringify(r)),f.append(i(e,s));var d=f.find(".list:last-child");d.find(".list__grid").html(l("list")),d.find(".task__grid").html(l()),d.find(".js-add-task").focus();var o=t(window);d.offset().top>o.scrollTop()+o.height()-30-80&&t("body").scrollTop(d.offset().top)})}(),function(){f.on("keyup change",".js-edit-list",function(e){var a=t(this),s=a.parents(".list").attr("data-id"),i=a.val(),n=JSON.parse(localStorage.getItem("mahoweek")),r=n.lists.filter(function(t){return t.id==s}),d=n.lists.indexOf(r[0]);n.lists[d].name=i,localStorage.setItem("mahoweek",JSON.stringify(n)),13==e.keyCode&&a.blur()})}(),function(){f.on("click",".js-remove-list",function(){var a=t(this),s=a.parents(".list").attr("data-id"),i=a.parents(".list").find(".task:not(.task--add)").length;if(i)var n=confirm("При удалении списка, все дела, находящиеся в нём, так же будут удалены.");if(!i||n){var r=JSON.parse(localStorage.getItem("mahoweek")),d=r.lists.filter(function(t){return t.id==s}),l=r.lists.indexOf(d[0]);if(r.lists.splice(l,1),i){for(var o=[],c=0;c<r.tasks.length;c++)r.tasks[c].listId!=s&&o.push(r.tasks[c]);r.tasks=o}localStorage.setItem("mahoweek",JSON.stringify(r)),a.parents(".list").remove(),e()}})}(),function(){var t=o?200:0;Sortable.create(document.querySelector(".board__lists"),{delay:t,animation:0,handle:".list__name",filter:".list__input",preventOnFilter:!1,ghostClass:"list--ghost",chosenClass:"list--chosen",dragClass:"list--drag",scrollSensitivity:80,onClone:function(){f.addClass("board__lists--drag")},onEnd:function(t){if(Number.isInteger(t.oldIndex)&&Number.isInteger(t.newIndex)&&t.oldIndex>=0&&t.newIndex>=0&&t.oldIndex!=t.newIndex){var e=JSON.parse(localStorage.getItem("mahoweek"));if(void 0!==e.lists[t.oldIndex]&&void 0!==e.lists[t.newIndex]){var a=e.lists.splice(t.oldIndex,1)[0];e.lists.splice(t.newIndex,0,a),localStorage.setItem("mahoweek",JSON.stringify(e))}else location.reload()}f.removeClass("board__lists--drag")}})}(),function(){for(var t=JSON.parse(localStorage.getItem("mahoweek")),a=0;a<t.tasks.length;a++){f.find('.list[data-id="'+t.tasks[a].listId+'"] .task--add').before(d(t.tasks[a].id,t.tasks[a].name,t.tasks[a].completed,t.tasks[a].markers));var i=f.find('.task[data-id="'+t.tasks[a].id+'"]');n(i)}for(var a=0;a<t.lists.length;a++)s(t.lists[a].id);"#welcome"!=window.location.hash&&c.addClass("board--load"),e()}(),function(){f.find(".js-add-task").focusin(function(){var e=t(this);e.parents(".task--add").addClass("task--focus")}),f.find(".js-add-task").focusout(function(){var e=t(this);e.parents(".task--add").removeClass("task--focus")})}(),function(){f.on("change",".js-add-task",function(){var e=t(this),i=e.parents(".list").attr("data-id"),n=e.val(),r=(new Date).getTime(),l=a(),o=JSON.parse(localStorage.getItem("mahoweek"));o.tasks.push({id:l,listId:i,name:n,createdTime:r}),localStorage.setItem("mahoweek",JSON.stringify(o)),e.val(""),e.parents(".task--add").before(d(l,n)),s(i);var c=e.parents(".task--add").prev(),g=t(window);c.offset().top>g.scrollTop()+g.height()-30-40-39&&t("body").scrollTop(g.scrollTop()+c.outerHeight(!0))})}(),function(){f.on("click",".js-completed-task",function(){var a=t(this),i=a.parents(".task"),r=i.parents(".list").attr("data-id"),d=i.attr("data-id"),l=i.hasClass("task--completed"),o=i.find(".grid__date--today").attr("data-date"),c=JSON.parse(localStorage.getItem("mahoweek")),g=c.tasks.filter(function(t){return t.id==d}),f=c.tasks.indexOf(g[0]);if(l){i.find(".grid__date--today").removeClass("grid__date--completed");var m="del";delete c.tasks[f].completed,delete c.tasks[f].completedTime,i.removeClass("task--completed")}else{if(i.find(".grid__date--today").toggleClass("grid__date--completed"),i.find(".grid__date--today").hasClass("grid__date--completed"))var m="add";else var m="del";if(i.find(".grid__date--today").hasClass("grid__date--bull")&&!i.find(".grid__date--today").nextAll(".grid__date--bull").length||!i.find(".grid__date--today").hasClass("grid__date--bull")&&i.find(".grid__date--today").nextAll(".grid__date--bull").length<=1){i.find(".grid__date--today").addClass("grid__date--completed"),m="add";var u=(new Date).getTime();c.tasks[f].completed=1,c.tasks[f].completedTime=u,i.addClass("task--completed")}}if(n(i),"add"!=m||c.tasks[f].markers){var k=c.tasks[f].markers.filter(function(t){return t.date==o});if(""!=k){var h=c.tasks[f].markers.indexOf(k[0]);"add"==m?c.tasks[f].markers[h].completed=1:c.tasks[f].markers[h].label?delete c.tasks[f].markers[h].completed:c.tasks[f].markers.splice(h,1)}else"add"==m&&c.tasks[f].markers.push({date:o,completed:1})}else c.tasks[f].markers=[{date:o,completed:1}];localStorage.setItem("mahoweek",JSON.stringify(c)),s(r),e()})}(),function(){f.on("keyup change",".js-edit-task",function(e){var a=t(this),s=a.parents(".task").attr("data-id"),i=a.val(),n=JSON.parse(localStorage.getItem("mahoweek")),r=n.tasks.filter(function(t){return t.id==s}),d=n.tasks.indexOf(r[0]);n.tasks[d].name=i,localStorage.setItem("mahoweek",JSON.stringify(n)),13==e.keyCode&&a.blur()})}(),function(){f.on("click",".js-remove-task",function(){var a=t(this),i=a.parents(".list").attr("data-id"),n=a.parents(".task").attr("data-id"),r=JSON.parse(localStorage.getItem("mahoweek")),d=r.tasks.filter(function(t){return t.id==n}),l=r.tasks.indexOf(d[0]);r.tasks.splice(l,1),localStorage.setItem("mahoweek",JSON.stringify(r)),a.parents(".task").remove(),s(i),e()})}(),function(){f.on("click",".task:not(.task--completed) .js-marker-task:not(.grid__date--past):not(.grid__date--completed)",function(){var a=t(this),s=a.parents(".task").attr("data-id"),i=a.attr("data-date"),r=JSON.parse(localStorage.getItem("mahoweek")),d=r.tasks.filter(function(t){return t.id==s}),l=r.tasks.indexOf(d[0]);if(r.tasks[l].markers){var o=r.tasks[l].markers.filter(function(t){return t.date==i});if(""!=o){var c=r.tasks[l].markers.indexOf(o[0]);r.tasks[l].markers.splice(c,1),a.removeClass("grid__date--bull")}else r.tasks[l].markers.push({date:i,label:"bull"}),a.addClass("grid__date--bull")}else r.tasks[l].markers=[{date:i,label:"bull"}],a.addClass("grid__date--bull");n(a.parents(".task")),localStorage.setItem("mahoweek",JSON.stringify(r)),e()})}(),function(){m.on("submit",function(t){t.preventDefault()});var t=JSON.parse(localStorage.getItem("mahoweek")),e=t.settings.theme;m.find('.js-choose-theme[value="'+e+'"]').attr("checked","checked"),m.find(":checkbox, :radio").on("change",function(){e=m.find('.js-choose-theme[name="theme"]:checked').val(),g.attr("class","board__theme  board__theme--"+e),t.settings.theme=e,localStorage.setItem("mahoweek",JSON.stringify(t))})}(),function(){u.on("submit",function(t){t.preventDefault();var e=JSON.parse(u.find(".js-edit-storage").val());localStorage.setItem("mahoweek",JSON.stringify(e)),location.replace("/")})}()}(jQuery);