!function(t){"use strict";function e(){for(var t="",e="0123456789abcdefghijklmnopqrstuvwxyz",a=0;a<8;a++)t+=e.charAt(Math.floor(Math.random()*e.length));return t}function a(t){var e=c.find('.list[data-id="'+t+'"] .task:not(.task--add)').length,a=c.find('.list[data-id="'+t+'"] .task--completed').length;if(e>0)var s=100*a/e/100;else var s=0;c.find('.list[data-id="'+t+'"] .list__progress').css({"-webkit-transform":"scaleX("+s+")",transform:"scaleX("+s+")"})}function s(t,e){return'<div class="list" data-id="'+t+'"><div class="list__head"><div class="list__wrap"><div class="list__name  js-name">'+e+'</div><div class="list__options"><div class="list__trash  js-remove-list"><svg><use xlink:href="#icon-trash"></use></svg></div></div><div class="list__progress"></div></div><div class="list__grid  grid"></div></div><div class="list__tasks"><label class="task  task--add"><div class="task__wrap"><div class="task__status"><div class="task__plus"><svg><use xlink:href="#icon-plus"></use></svg></div></div><div class="task__name"><input class="task__input  js-add-task" type="text" maxlength="255"></div></div><div class="task__grid  grid"></div></label></div></div>'}function i(t){var e=t;return e=/https:\/\/mahoweek\.ru\/#/.test(t)?e.replace(/(https:\/\/)(mahoweek\.ru\/#)([\S]+[^ ,\.!])/gi,'<a href="#$3" class="cartonbox" data-cb-type="inline" data-cb-hash="$3"><span class="hidden">$1</span>$2$3</a>'):e.replace(/(http(s)?:\/\/(www\.)?)([\S]+[^ ,\.!])/gi,'<a href="$1$4" class="js-link-task" target="_blank" rel="noopener noreferrer"><span class="hidden">$1</span>$4</a>')}function d(t,e,a,s){if(1==a)var a=" task--completed";else var a="";return'<div class="task'+a+'" data-id="'+t+'"><div class="task__wrap"><div class="task__status"><div class="task__check  js-completed-task"></div></div><div class="task__name  js-name">'+i(e)+'</div><div class="task__options"><div class="task__trash  js-remove-task"><svg><use xlink:href="#icon-trash"></use></svg></div></div></div><div class="task__grid  grid">'+l("task",s)+"</div></div>"}function l(t,e){var a=new Date,s=a.getDay();0==s&&(s=7);var i=1;if(e)for(var d={},l=0;l<e.length;l++){var r=e[l].date;d[r]=e[l].label+"|"+(e[l].completed?1:0)}for(var n="",l=1-s;l<=14-s;l++){var o="",c=new Date,k=c.setDate(a.getDate()+l),m=c.getDate(k),g=c.getMonth(k)+1,f=c.getFullYear(k),_=c.getDay(),u=(m<10?"0"+m:m)+"."+(g<10?"0"+g:g)+"."+f;0==_&&(_=7),a.getDate()==m&&(o+=" grid__date--today",i=0),i&&(o+=" grid__date--past"),6!=_&&7!=_||(o+=" grid__date--holiday"),"task"==t&&(o+=" js-marker-task",d&&u in d&&("bull"==d[u].split("|")[0]&&(o+=" grid__date--bull"),1==d[u].split("|")[1]&&(o+=" grid__date--completed"))),n+='<div class="grid__date'+o+'" data-date="'+u+'">',"list"==t&&(n+=m),n+="</div>"}return n}if(setTimeout(function(){t("body").scrollTop(0)},1),/Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent)){t("body").addClass("mobile");var r=1}var n=t(".board"),o=n.find(".board__theme"),c=n.find(".board__lists"),k=t(".form--settings");!function(){if(localStorage.getItem("mahoweek")){var a=JSON.parse(localStorage.getItem("mahoweek"));o.addClass("board__theme--"+a.settings.theme)}else{var s=e(),i="leaves",d={lists:[{id:s,name:"Краткосрочный план дел",createdTime:(new Date).getTime()}],tasks:[{id:e(),listId:s,name:"Прочитать справку о сайте: https://mahoweek.ru/#about",createdTime:(new Date).getTime()},{id:e(),listId:s,name:"Настроить доску: https://mahoweek.ru/#settings",createdTime:(new Date).getTime()},{id:e(),listId:s,name:"Добавить ещё дел в список",createdTime:(new Date).getTime()},{id:e(),listId:s,name:"Наметить на календарной сетке даты выполнения задач",createdTime:(new Date).getTime()}],settings:{theme:i}};localStorage.setItem("mahoweek",JSON.stringify(d)),o.addClass("board__theme--"+i),t("body").attr("data-visit","first")}}(),function(){var e=0,a=0,s=r?"touchstart":"mousedown";c.on(s,".js-name",function(t){if("touchstart"==t.type){var a=t.originalEvent.touches[0]||t.originalEvent.changedTouches[0];e=a.pageX+a.pageY}else e=t.pageX+t.pageY;c.find(".js-add-task").blur()});var d=r?"touchend":"mouseup";c.on(d,".js-name",function(s){var d=t(this);if("touchend"==s.type){var l=s.originalEvent.touches[0]||s.originalEvent.changedTouches[0];a=l.pageX+l.pageY}else a=s.pageX+s.pageY;if("mouseup"==s.type&&1!=s.which)return!1;if(!t(s.target).hasClass("js-link-task")&&!t(s.target).hasClass("cartonbox")&&e==a){if(d.hasClass("list__name")&&!d.parents(".list").find(".list__input").length){var r=d.text();d.html('<input class="list__input  js-edit-list" type="text" maxlength="255" value="">'),d.parents(".list").find(".list__input").focus().val(r),d.parents(".list").find(".list__input").focusout(function(){d.text(t(this).val())})}if(d.hasClass("task__name")&&!d.parents(".task").find(".task__input").length){var n=d.text();d.html('<input class="task__input  js-edit-task" type="text" maxlength="255" value="">'),d.parents(".task").find(".task__input").focus().val(n),d.parents(".task").find(".task__input").focusout(function(){d.html(i(t(this).val()))})}}})}(),function(){var e={speed:100,preload:!1,closeHtml:'<svg><use xlink:href="#icon-close"></use></svg>',onStartBefore:function(){t(".cartonbox-close").prependTo(".cartonbox-container")}};t.cartonbox(e),"first"==t("body").attr("data-visit")&&t(".js-open-welcome").trigger("click"),t(".js-close-welcome").on("click",function(){t(".cartonbox-close").trigger("click"),n.addClass("board--load")})}(),function(){for(var t=JSON.parse(localStorage.getItem("mahoweek")),e="",a=0;a<t.lists.length;a++)e+=s(t.lists[a].id,t.lists[a].name);c.prepend(e)}(),c.find(".list__grid").html(l("list")),c.find(".task__grid").html(l()),function(){t(".js-add-list").on("click",function(){var a=e(),i="Краткосрочный план дел №"+(c.find(".list").length+1),d=(new Date).getTime(),r=JSON.parse(localStorage.getItem("mahoweek"));r.lists.push({id:a,name:i,createdTime:d}),localStorage.setItem("mahoweek",JSON.stringify(r)),c.append(s(a,i));var n=c.find(".list:last-child");n.find(".list__grid").html(l("list")),n.find(".task__grid").html(l()),n.find(".js-add-task").focus();var o=t(window);n.offset().top>o.scrollTop()+o.height()-30-80&&t("body").scrollTop(n.offset().top)})}(),function(){c.on("keyup change",".js-edit-list",function(e){var a=t(this),s=a.parents(".list").attr("data-id"),i=a.val(),d=JSON.parse(localStorage.getItem("mahoweek")),l=d.lists.filter(function(t){return t.id==s}),r=d.lists.indexOf(l[0]);d.lists[r].name=i,localStorage.setItem("mahoweek",JSON.stringify(d)),13==e.keyCode&&a.blur()})}(),function(){c.on("click",".js-remove-list",function(){var e=t(this),a=e.parents(".list").attr("data-id"),s=e.parents(".list").find(".task:not(.task--add)").length;if(s)var i=confirm("При удалении списка, все дела, находящиеся в нём, так же будут удалены.");if(!s||i){var d=JSON.parse(localStorage.getItem("mahoweek")),l=d.lists.filter(function(t){return t.id==a}),r=d.lists.indexOf(l[0]);if(d.lists.splice(r,1),s){for(var n=[],o=0;o<d.tasks.length;o++)d.tasks[o].listId!=a&&n.push(d.tasks[o]);d.tasks=n}localStorage.setItem("mahoweek",JSON.stringify(d)),e.parents(".list").remove()}})}(),function(){var t=r?200:0;Sortable.create(document.querySelector(".board__lists"),{delay:t,animation:0,handle:".list__name",filter:".list__input",preventOnFilter:!1,ghostClass:"list--ghost",chosenClass:"list--chosen",dragClass:"list--drag",scrollSensitivity:80,onChoose:function(){c.addClass("board__lists--drag")},onEnd:function(t){if(Number.isInteger(t.oldIndex)&&Number.isInteger(t.newIndex)&&t.oldIndex!=t.newIndex){var e=JSON.parse(localStorage.getItem("mahoweek")),a=e.lists.splice(t.oldIndex,1)[0];void 0!==a?(e.lists.splice(t.newIndex,0,a),localStorage.setItem("mahoweek",JSON.stringify(e))):location.reload()}c.removeClass("board__lists--drag")}})}(),function(){for(var t=JSON.parse(localStorage.getItem("mahoweek")),e=0;e<t.tasks.length;e++){c.find('.list[data-id="'+t.tasks[e].listId+'"] .task--add').before(d(t.tasks[e].id,t.tasks[e].name,t.tasks[e].completed,t.tasks[e].markers));var s=c.find('.task[data-id="'+t.tasks[e].id+'"]');s.find(".grid__date--today.grid__date--bull:not(.grid__date--completed)").length&&s.addClass("task--today")}for(var e=0;e<t.lists.length;e++)a(t.lists[e].id);"#welcome"!=window.location.hash&&n.addClass("board--load")}(),function(){c.find(".js-add-task").focusin(function(){var e=t(this);e.parents(".task--add").addClass("task--focus")}),c.find(".js-add-task").focusout(function(){var e=t(this);e.parents(".task--add").removeClass("task--focus")})}(),function(){c.on("change",".js-add-task",function(){var s=t(this),i=s.parents(".list").attr("data-id"),l=s.val(),r=(new Date).getTime(),n=e(),o=JSON.parse(localStorage.getItem("mahoweek"));o.tasks.push({id:n,listId:i,name:l,createdTime:r}),localStorage.setItem("mahoweek",JSON.stringify(o)),s.val(""),s.parents(".task--add").before(d(n,l)),a(i);var c=s.parents(".task--add").prev(),k=t(window);c.offset().top>k.scrollTop()+k.height()-30-40-39&&t("body").scrollTop(k.scrollTop()+c.outerHeight(!0))})}(),function(){c.on("click",".js-completed-task",function(){var e=t(this),s=e.parents(".task"),i=s.parents(".list").attr("data-id"),d=s.attr("data-id"),l=s.hasClass("task--completed"),r=s.find(".grid__date--today").attr("data-date"),n=JSON.parse(localStorage.getItem("mahoweek")),o=n.tasks.filter(function(t){return t.id==d}),c=n.tasks.indexOf(o[0]);if(l){s.find(".grid__date--today").removeClass("grid__date--completed");var k="del";delete n.tasks[c].completed,delete n.tasks[c].completedTime,s.removeClass("task--completed")}else{if(s.find(".grid__date--today").toggleClass("grid__date--completed"),s.find(".grid__date--today").hasClass("grid__date--completed"))var k="add";else var k="del";if(s.find(".grid__date--today").hasClass("grid__date--bull")&&!s.find(".grid__date--today").nextAll(".grid__date--bull").length||!s.find(".grid__date--today").hasClass("grid__date--bull")&&s.find(".grid__date--today").nextAll(".grid__date--bull").length<=1){s.find(".grid__date--today").addClass("grid__date--completed"),k="add";var m=(new Date).getTime();n.tasks[c].completed=1,n.tasks[c].completedTime=m,s.addClass("task--completed")}}if(s.find(".grid__date--today.grid__date--bull:not(.grid__date--completed)").length?s.addClass("task--today"):s.removeClass("task--today"),"add"!=k||n.tasks[c].markers){var g=n.tasks[c].markers.filter(function(t){return t.date==r});if(""!=g){var f=n.tasks[c].markers.indexOf(g[0]);"add"==k?n.tasks[c].markers[f].completed=1:n.tasks[c].markers[f].label?delete n.tasks[c].markers[f].completed:n.tasks[c].markers.splice(f,1)}else"add"==k&&n.tasks[c].markers.push({date:r,completed:1})}else n.tasks[c].markers=[{date:r,completed:1}];localStorage.setItem("mahoweek",JSON.stringify(n)),a(i)})}(),function(){c.on("keyup change",".js-edit-task",function(e){var a=t(this),s=a.parents(".task").attr("data-id"),i=a.val(),d=JSON.parse(localStorage.getItem("mahoweek")),l=d.tasks.filter(function(t){return t.id==s}),r=d.tasks.indexOf(l[0]);d.tasks[r].name=i,localStorage.setItem("mahoweek",JSON.stringify(d)),13==e.keyCode&&a.blur()})}(),function(){c.on("click",".js-remove-task",function(){var e=t(this),s=e.parents(".list").attr("data-id"),i=e.parents(".task").attr("data-id"),d=JSON.parse(localStorage.getItem("mahoweek")),l=d.tasks.filter(function(t){return t.id==i}),r=d.tasks.indexOf(l[0]);d.tasks.splice(r,1),localStorage.setItem("mahoweek",JSON.stringify(d)),e.parents(".task").remove(),a(s)})}(),function(){c.on("click",".task:not(.task--completed) .js-marker-task:not(.grid__date--past):not(.grid__date--completed)",function(){var e=t(this),a=e.parents(".task").attr("data-id"),s=e.attr("data-date"),i=JSON.parse(localStorage.getItem("mahoweek")),d=i.tasks.filter(function(t){return t.id==a}),l=i.tasks.indexOf(d[0]);if(i.tasks[l].markers){var r=i.tasks[l].markers.filter(function(t){return t.date==s});if(""!=r){var n=i.tasks[l].markers.indexOf(r[0]);i.tasks[l].markers.splice(n,1),e.removeClass("grid__date--bull")}else i.tasks[l].markers.push({date:s,label:"bull"}),e.addClass("grid__date--bull")}else i.tasks[l].markers=[{date:s,label:"bull"}],e.addClass("grid__date--bull");e.parents(".task").find(".grid__date--today.grid__date--bull:not(.grid__date--completed)").length?e.parents(".task").addClass("task--today"):e.parents(".task").removeClass("task--today"),localStorage.setItem("mahoweek",JSON.stringify(i))})}(),function(){k.on("submit",function(t){t.preventDefault()});var t=JSON.parse(localStorage.getItem("mahoweek")),e=t.settings.theme;k.find('.js-choose-theme[value="'+e+'"]').attr("checked","checked"),k.find(":checkbox, :radio").on("change",function(){e=k.find('.js-choose-theme[name="theme"]:checked').val(),o.attr("class","board__theme  board__theme--"+e),t.settings.theme=e,localStorage.setItem("mahoweek",JSON.stringify(t))})}()}(jQuery);