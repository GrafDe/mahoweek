!function(t){"use strict";function e(){for(var t="",e="0123456789abcdefghijklmnopqrstuvwxyz",a=0;a<8;a++)t+=e.charAt(Math.floor(Math.random()*e.length));return t}function a(t){var e=c.find('.list[data-id="'+t+'"] .task:not(.task--add)').length,a=c.find('.list[data-id="'+t+'"] .task--completed').length;if(e>0)var s=100*a/e/100;else var s=0;c.find('.list[data-id="'+t+'"] .list__progress').css({"-webkit-transform":"scaleX("+s+")",transform:"scaleX("+s+")"})}function s(t,e){return'<div class="list" data-id="'+t+'"><div class="list__head"><div class="list__wrap"><div class="list__name  js-name">'+e+'</div><div class="list__options"><div class="list__trash  js-remove-list"><svg><use xlink:href="#icon-trash"></use></svg></div></div><div class="list__progress"></div></div><div class="list__grid  grid"></div></div><div class="list__tasks"><label class="task  task--add"><div class="task__wrap"><div class="task__status"><div class="task__plus"><svg><use xlink:href="#icon-plus"></use></svg></div></div><div class="task__name"><input class="task__input  js-add-task" type="text" maxlength="255"></div></div><div class="task__grid  grid"></div></label></div></div>'}function d(t){var e=t;return e=/https:\/\/mahoweek\.ru\/#/.test(t)?e.replace(/(https:\/\/)(mahoweek\.ru\/#)([\S]+[^ ,\.!])/gi,'<a href="#$3" class="cartonbox" data-cb-type="inline" data-cb-hash="$3"><span class="hidden">$1</span>$2$3</a>'):e.replace(/(http(s)?:\/\/(www\.)?)([\S]+[^ ,\.!])/gi,'<a href="$1$4" class="js-link-task" target="_blank" rel="noopener noreferrer"><span class="hidden">$1</span>$4</a>'),e=e.replace(/(.+)?(\s)?(\[)(\d\d:\d\d)(\])(\s)?(.+)?/gi,'<span class="hidden">$3</span><span class="task__time">$4</span><span class="hidden">$5</span> $1$7').trim(),/[!]{3,}/.test(t)&&(e="<strong>"+e.replace(/([!]{3,})/gi,'<span class="hidden">$1</span>')+"</strong>"),e}function i(t,e,a,s){if(1==a)var a=" task--completed";else var a="";return'<div class="task'+a+'" data-id="'+t+'"><div class="task__wrap"><div class="task__status"><div class="task__check  js-completed-task"></div></div><div class="task__name  js-name">'+d(e)+'</div><div class="task__options"><div class="task__trash  js-remove-task"><svg><use xlink:href="#icon-trash"></use></svg></div></div></div><div class="task__grid  grid">'+r("task",s)+"</div></div>"}function r(t,e){var a=new Date,s=a.getDay();0==s&&(s=7);var d=1;if(e)for(var i={},r=0;r<e.length;r++){var l=e[r].date;i[l]=e[r].label+"|"+(e[r].completed?1:0)}for(var n="",r=1-s;r<=14-s;r++){var o="",c=new Date,_=c.setDate(a.getDate()+r),g=c.getDate(_),m=c.getMonth(_)+1,k=c.getFullYear(_),p=c.getDay(),f=(g<10?"0"+g:g)+"."+(m<10?"0"+m:m)+"."+k;0==p&&(p=7),a.getDate()==g&&(o+=" grid__date--today",d=0),d&&(o+=" grid__date--past"),6!=p&&7!=p||(o+=" grid__date--holiday"),"task"==t&&(o+=" js-marker-task",i&&f in i&&("bull"==i[f].split("|")[0]&&(o+=" grid__date--bull"),1==i[f].split("|")[1]&&(o+=" grid__date--completed"))),n+='<div class="grid__date'+o+'" data-date="'+f+'">',"list"==t&&(n+=g),n+="</div>"}return n}if(setTimeout(function(){t("body").scrollTop(0)},1),/Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent)){t("body").addClass("mobile");var l=1}var n=t(".board"),o=n.find(".board__theme"),c=n.find(".board__lists"),_=t(".form--settings");!function(){if(localStorage.getItem("mahoweek")){var a=JSON.parse(localStorage.getItem("mahoweek"));o.addClass("board__theme--"+a.settings.theme)}else{var s=e(),d="leaves",i={lists:[{id:s,name:"Краткосрочный план дел",createdTime:(new Date).getTime()}],tasks:[{id:e(),listId:s,name:"Прочитать справку о сайте: https://mahoweek.ru/#about",createdTime:(new Date).getTime()},{id:e(),listId:s,name:"Посмотреть как здесь всё устроено: https://mahoweek.ru/#tour",createdTime:(new Date).getTime()},{id:e(),listId:s,name:"Настроить доску: https://mahoweek.ru/#settings",createdTime:(new Date).getTime()},{id:e(),listId:s,name:"Добавить ещё дел в список",createdTime:(new Date).getTime()},{id:e(),listId:s,name:"Наметить на календарной сетке даты выполнения задач",createdTime:(new Date).getTime()}],settings:{theme:d}};localStorage.setItem("mahoweek",JSON.stringify(i)),o.addClass("board__theme--"+d),t("body").attr("data-visit","first")}}(),function(){var e=0,a=0,s=l?"touchstart":"mousedown";c.on(s,".js-name",function(t){if("touchstart"==t.type){var a=t.originalEvent.touches[0]||t.originalEvent.changedTouches[0];e=a.pageX+a.pageY}else e=t.pageX+t.pageY;c.find(".js-add-task").blur()});var i=l?"touchend":"mouseup";c.on(i,".js-name",function(s){var i=t(this);if("touchend"==s.type){var r=s.originalEvent.touches[0]||s.originalEvent.changedTouches[0];a=r.pageX+r.pageY}else a=s.pageX+s.pageY;if("mouseup"==s.type&&1!=s.which)return!1;if(!t(s.target).hasClass("js-link-task")&&!t(s.target).hasClass("cartonbox")&&e==a){if(i.hasClass("list__name")&&!i.parents(".list").find(".list__input").length){var l=i.text();i.html('<input class="list__input  js-edit-list" type="text" maxlength="255" value="">'),i.parents(".list").find(".list__input").focus().val(l),i.parents(".list").find(".list__input").focusout(function(){i.text(t(this).val())})}if(i.hasClass("task__name")&&!i.parents(".task").find(".task__input").length){var n=i.text();i.html('<input class="task__input  js-edit-task" type="text" maxlength="255" value="">'),i.parents(".task").find(".task__input").focus().val(n),i.parents(".task").find(".task__input").focusout(function(){i.html(d(t(this).val()))})}}})}(),function(){var e={speed:1,preload:!1,closeHtml:'<svg><use xlink:href="#icon-close"></use></svg>',onStartBefore:function(){t(".cartonbox-close").prependTo(".cartonbox-container")}};t.cartonbox(e),"first"==t("body").attr("data-visit")&&t(".js-open-welcome").trigger("click"),t(".js-close-welcome").on("click",function(){t(".cartonbox-close").trigger("click"),n.addClass("board--load")})}(),function(){for(var t=JSON.parse(localStorage.getItem("mahoweek")),e="",a=0;a<t.lists.length;a++)e+=s(t.lists[a].id,t.lists[a].name);c.prepend(e)}(),c.find(".list__grid").html(r("list")),c.find(".task__grid").html(r()),function(){t(".js-add-list").on("click",function(){var a=e(),d="Краткосрочный план дел №"+(c.find(".list").length+1),i=(new Date).getTime(),l=JSON.parse(localStorage.getItem("mahoweek"));l.lists.push({id:a,name:d,createdTime:i}),localStorage.setItem("mahoweek",JSON.stringify(l)),c.append(s(a,d));var n=c.find(".list:last-child");n.find(".list__grid").html(r("list")),n.find(".task__grid").html(r()),n.find(".js-add-task").focus();var o=t(window);n.offset().top>o.scrollTop()+o.height()-30-80&&t("body").scrollTop(n.offset().top)})}(),function(){c.on("keyup change",".js-edit-list",function(e){var a=t(this),s=a.parents(".list").attr("data-id"),d=a.val(),i=JSON.parse(localStorage.getItem("mahoweek")),r=i.lists.filter(function(t){return t.id==s}),l=i.lists.indexOf(r[0]);i.lists[l].name=d,localStorage.setItem("mahoweek",JSON.stringify(i)),13==e.keyCode&&a.blur()})}(),function(){c.on("click",".js-remove-list",function(){var e=t(this),a=e.parents(".list").attr("data-id"),s=e.parents(".list").find(".task:not(.task--add)").length;if(s)var d=confirm("При удалении списка, все дела, находящиеся в нём, так же будут удалены.");if(!s||d){var i=JSON.parse(localStorage.getItem("mahoweek")),r=i.lists.filter(function(t){return t.id==a}),l=i.lists.indexOf(r[0]);if(i.lists.splice(l,1),s){for(var n=[],o=0;o<i.tasks.length;o++)i.tasks[o].listId!=a&&n.push(i.tasks[o]);i.tasks=n}localStorage.setItem("mahoweek",JSON.stringify(i)),e.parents(".list").remove()}})}(),function(){var t=l?200:0;Sortable.create(document.querySelector(".board__lists"),{delay:t,animation:0,handle:".list__name",filter:".list__input",preventOnFilter:!1,ghostClass:"list--ghost",chosenClass:"list--chosen",dragClass:"list--drag",scrollSensitivity:80,onChoose:function(){c.addClass("board__lists--drag")},onEnd:function(t){if(Number.isInteger(t.oldIndex)&&Number.isInteger(t.newIndex)&&t.oldIndex!=t.newIndex){var e=JSON.parse(localStorage.getItem("mahoweek")),a=e.lists.splice(t.oldIndex,1)[0];void 0!==a?(e.lists.splice(t.newIndex,0,a),localStorage.setItem("mahoweek",JSON.stringify(e))):location.reload()}c.removeClass("board__lists--drag")}})}(),function(){for(var t=JSON.parse(localStorage.getItem("mahoweek")),e=0;e<t.tasks.length;e++){c.find('.list[data-id="'+t.tasks[e].listId+'"] .task--add').before(i(t.tasks[e].id,t.tasks[e].name,t.tasks[e].completed,t.tasks[e].markers));var s=c.find('.task[data-id="'+t.tasks[e].id+'"]');s.find(".grid__date.grid__date--past.grid__date--bull:not(.grid__date--completed)").length&&!s.find(".grid__date.grid__date--today.grid__date--completed").length&&s.find(".grid__date.grid__date--past.grid__date--bull:not(.grid__date--completed):last").index()>s.find(".grid__date.grid__date--past.grid__date--completed:last").index()&&s.addClass("task--past"),s.find(".grid__date:not(.grid__date--past):not(.grid__date--completed).grid__date--bull").length&&s.addClass("task--bull"),s.find(".grid__date--today.grid__date--bull:not(.grid__date--completed)").length&&s.addClass("task--today")}for(var e=0;e<t.lists.length;e++)a(t.lists[e].id);"#welcome"!=window.location.hash&&n.addClass("board--load")}(),function(){c.find(".js-add-task").focusin(function(){var e=t(this);e.parents(".task--add").addClass("task--focus")}),c.find(".js-add-task").focusout(function(){var e=t(this);e.parents(".task--add").removeClass("task--focus")})}(),function(){c.on("change",".js-add-task",function(){var s=t(this),d=s.parents(".list").attr("data-id"),r=s.val(),l=(new Date).getTime(),n=e(),o=JSON.parse(localStorage.getItem("mahoweek"));o.tasks.push({id:n,listId:d,name:r,createdTime:l}),localStorage.setItem("mahoweek",JSON.stringify(o)),s.val(""),s.parents(".task--add").before(i(n,r)),a(d);var c=s.parents(".task--add").prev(),_=t(window);c.offset().top>_.scrollTop()+_.height()-30-40-39&&t("body").scrollTop(_.scrollTop()+c.outerHeight(!0))})}(),function(){c.on("click",".js-completed-task",function(){var e=t(this),s=e.parents(".task"),d=s.parents(".list").attr("data-id"),i=s.attr("data-id"),r=s.hasClass("task--completed"),l=s.find(".grid__date--today").attr("data-date"),n=JSON.parse(localStorage.getItem("mahoweek")),o=n.tasks.filter(function(t){return t.id==i}),c=n.tasks.indexOf(o[0]);if(r){s.find(".grid__date--today").removeClass("grid__date--completed");var _="del";delete n.tasks[c].completed,delete n.tasks[c].completedTime,s.removeClass("task--completed")}else{if(s.find(".grid__date--today").toggleClass("grid__date--completed"),s.find(".grid__date--today").hasClass("grid__date--completed"))var _="add";else var _="del";if(s.find(".grid__date--today").hasClass("grid__date--bull")&&!s.find(".grid__date--today").nextAll(".grid__date--bull").length||!s.find(".grid__date--today").hasClass("grid__date--bull")&&s.find(".grid__date--today").nextAll(".grid__date--bull").length<=1){s.find(".grid__date--today").addClass("grid__date--completed"),_="add";var g=(new Date).getTime();n.tasks[c].completed=1,n.tasks[c].completedTime=g,s.addClass("task--completed")}}if(s.find(".grid__date--today.grid__date--bull:not(.grid__date--completed)").length?s.addClass("task--today"):s.removeClass("task--today"),"add"!=_||n.tasks[c].markers){var m=n.tasks[c].markers.filter(function(t){return t.date==l});if(""!=m){var k=n.tasks[c].markers.indexOf(m[0]);"add"==_?n.tasks[c].markers[k].completed=1:n.tasks[c].markers[k].label?delete n.tasks[c].markers[k].completed:n.tasks[c].markers.splice(k,1)}else"add"==_&&n.tasks[c].markers.push({date:l,completed:1})}else n.tasks[c].markers=[{date:l,completed:1}];localStorage.setItem("mahoweek",JSON.stringify(n)),a(d)})}(),function(){c.on("keyup change",".js-edit-task",function(e){var a=t(this),s=a.parents(".task").attr("data-id"),d=a.val(),i=JSON.parse(localStorage.getItem("mahoweek")),r=i.tasks.filter(function(t){return t.id==s}),l=i.tasks.indexOf(r[0]);i.tasks[l].name=d,localStorage.setItem("mahoweek",JSON.stringify(i)),13==e.keyCode&&a.blur()})}(),function(){c.on("click",".js-remove-task",function(){var e=t(this),s=e.parents(".list").attr("data-id"),d=e.parents(".task").attr("data-id"),i=JSON.parse(localStorage.getItem("mahoweek")),r=i.tasks.filter(function(t){return t.id==d}),l=i.tasks.indexOf(r[0]);i.tasks.splice(l,1),localStorage.setItem("mahoweek",JSON.stringify(i)),e.parents(".task").remove(),a(s)})}(),function(){c.on("click",".task:not(.task--completed) .js-marker-task:not(.grid__date--past):not(.grid__date--completed)",function(){var e=t(this),a=e.parents(".task").attr("data-id"),s=e.attr("data-date"),d=JSON.parse(localStorage.getItem("mahoweek")),i=d.tasks.filter(function(t){return t.id==a}),r=d.tasks.indexOf(i[0]);if(d.tasks[r].markers){var l=d.tasks[r].markers.filter(function(t){return t.date==s});if(""!=l){var n=d.tasks[r].markers.indexOf(l[0]);d.tasks[r].markers.splice(n,1),e.removeClass("grid__date--bull")}else d.tasks[r].markers.push({date:s,label:"bull"}),e.addClass("grid__date--bull")}else d.tasks[r].markers=[{date:s,label:"bull"}],e.addClass("grid__date--bull");e.parents(".task").find(".grid__date.grid__date--past.grid__date--bull:not(.grid__date--completed)").length&&!e.parents(".task").find(".grid__date.grid__date--today.grid__date--completed").length&&e.parents(".task").find(".grid__date.grid__date--past.grid__date--bull:not(.grid__date--completed):last").index()>e.parents(".task").find(".grid__date.grid__date--past.grid__date--completed:last").index()?e.parents(".task").addClass("task--past"):e.parents(".task").removeClass("task--past"),e.parents(".task").find(".grid__date:not(.grid__date--past):not(.grid__date--completed).grid__date--bull").length?e.parents(".task").addClass("task--bull"):e.parents(".task").removeClass("task--bull"),e.parents(".task").find(".grid__date--today.grid__date--bull:not(.grid__date--completed)").length?e.parents(".task").addClass("task--today"):e.parents(".task").removeClass("task--today"),localStorage.setItem("mahoweek",JSON.stringify(d))})}(),function(){_.on("submit",function(t){t.preventDefault()});var t=JSON.parse(localStorage.getItem("mahoweek")),e=t.settings.theme;_.find('.js-choose-theme[value="'+e+'"]').attr("checked","checked"),_.find(":checkbox, :radio").on("change",function(){e=_.find('.js-choose-theme[name="theme"]:checked').val(),o.attr("class","board__theme  board__theme--"+e),t.settings.theme=e,localStorage.setItem("mahoweek",JSON.stringify(t))})}()}(jQuery);